<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Partidos - Liga Ñanguete</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

  :root {
    --primary-color: #3f51b5; /* Deeper blue for primary actions/headers */
    --secondary-color: #ff9800; /* Vibrant orange for accents */
    --background-color: #f0f2f5; /* Light grey for softer background */
    --text-color: #333;
    --light-color: #fff;
    --border-color: #e0e0e0; /* Softer border color */
    --success-color: #4caf50;
    --error-color: #f44336;
    --info-color: #2196f3;
    --warning-color: #ffc107; /* Brighter warning color */
    --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
    --shadow-medium: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);

    /* Variables for sticky column widths */
    --col1-width: 40px; /* Width for '#' column - reduced */
    --col2-width: 110px; /* Adjusted Width for 'Jugador' column - smaller */
    --col3-width: 70px; /* Width for 'Posición' column - smaller */
    --col-delete-width: 40px; /* Width for 'Eliminar' column (the 'x' button) */
  }

  body {
    font-family: 'Roboto', sans-serif;
    background: var(--background-color);
    margin: 0;
    padding: 20px;
    color: var(--text-color);
    line-height: 1.6;
    box-sizing: border-box; /* Ensures padding doesn't affect total width */
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: var(--primary-color);
    padding: 15px 25px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-medium);
    color: var(--light-color);
    flex-wrap: wrap; /* Allows items to wrap on smaller screens */
  }

  header img {
    height: 65px; /* Slightly larger logo */
    filter: drop-shadow(0 3px 4px rgba(0, 0, 0, 0.3));
    margin-right: 15px; /* Space between logo and title */
  }

  header h1 {
    margin: 0;
    font-size: 28px; /* Larger title */
    color: var(--light-color);
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    flex-grow: 1;
    text-align: center;
    font-weight: 700;
  }

  .header-button {
    background-color: var(--light-color);
    color: var(--primary-color);
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-light);
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: 15px; /* Space between title and button */
  }

  .header-button:hover {
    background-color: var(--secondary-color);
    color: var(--light-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
  }

  .section-container {
    background: var(--light-color);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-light);
    transition: transform 0.2s ease-in-out;
  }

  .section-container:hover {
    transform: translateY(-3px);
  }

  h2 {
    margin-top: 0; /* Remove default top margin */
    margin-bottom: 20px;
    color: var(--primary-color);
    border-bottom: 3px solid var(--secondary-color); /* Thicker, more pronounced border */
    padding-bottom: 10px;
    font-size: 24px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
  }
    /* Added for sticky lineup titles */
  .lineup-header-container {
    position: sticky;
    top: 0; /* Or adjust if you have a sticky header above this */
    z-index: 100; /* Ensure it stays on top */
    background: var(--light-color); /* Match section container background */
    padding-top: 15px; /* Add some padding if needed */
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color); /* Optional: a subtle border */
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .lineup-header-container h2 {
    margin: 0; /* Remove default margins */
    border-bottom: none; /* Remove border as it's now on the container */
  }

  .form-group {
    display: grid; /* Use CSS Grid for better control */
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive columns */
    gap: 20px;
    margin-bottom: 25px;
    padding: 20px;
    border-radius: 8px;
    background-color: #fdfdfd; /* Slightly different background for form */
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05); /* Inner shadow for depth */
  }

  .form-group label {
    font-weight: bold;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-group input,
  .form-group select {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    width: 100%;
    font-size: 16px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    background-color: var(--light-color);
  }

  .form-group input:focus,
  .form-group select:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2); /* Primary color shadow */
  }

  /* Added a wrapper for tables to handle overflow */
  .table-wrapper {
    width: 100%;
    overflow-x: auto; /* Enable horizontal scrolling */
    margin-top: 20px;
    box-shadow: var(--shadow-light);
    border-radius: 12px;
  }

  table {
    width: 100%;
    border-collapse: separate; /* Use separate for border-radius on cells */
    border-spacing: 0;
    background-color: var(--light-color);
    min-width: fit-content; /* Ensure table doesn't shrink smaller than content */
  }

  th,
  td {
    padding: 14px 10px;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
    white-space: nowrap; /* Prevent content from wrapping in cells */
    min-width: 60px; /* Ensure a minimum width for readability */
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
  }

  th {
    background-color: var(--primary-color);
    color: var(--light-color);
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: sticky; /* Make headers stick on scroll */
    top: 0;
    z-index: 10;
  }

  /* Specific styling for table header corners */
  .table-wrapper thead th:first-child {
    border-top-left-radius: 12px;
  }

  .table-wrapper thead th:last-child {
    border-top-right-radius: 12px;
  }

  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  tr:hover {
    background-color: #eef;
    transform: scale(1.005);
    transition: background-color 0.2s ease, transform 0.2s ease;
  }

  /* --- Sticky Columns for Lineup Tables --- */
  /* # column */
  .sticky-column-1 {
    position: sticky;
    left: 0;
    z-index: 5; /* Lower than header, higher than regular cells */
    background-color: var(--light-color); /* Ensure background is solid */
    min-width: var(--col1-width);
    width: var(--col1-width);
    max-width: var(--col1-width);
  }
  .table-wrapper thead .sticky-column-1 {
    z-index: 15; /* Higher than regular headers */
    background-color: var(--primary-color);
  }

  /* Jugador column */
  .sticky-column-2 {
    position: sticky;
    left: var(--col1-width);
    z-index: 4;
    background-color: var(--light-color);
    min-width: var(--col2-width);
    width: var(--col2-width);
    max-width: var(--col2-width);
  }
  .table-wrapper thead .sticky-column-2 {
    z-index: 14;
    background-color: var(--primary-color);
  }

  /* Posicion column */
  .sticky-column-3 {
    position: sticky;
    left: calc(var(--col1-width) + var(--col2-width));
    z-index: 3;
    background-color: var(--light-color);
    min-width: var(--col3-width);
    width: var(--col3-width);
    max-width: var(--col3-width);
  }
  .table-wrapper thead .sticky-column-3 {
    z-index: 13;
    background-color: var(--primary-color);
  }
  
  /* NEW: Delete Button column */
  .sticky-column-delete {
    position: sticky;
    left: calc(var(--col1-width) + var(--col2-width) + var(--col3-width)); /* Position after other sticky columns */
    z-index: 2; /* Lower than other sticky columns, higher than regular cells */
    background-color: var(--light-color);
    min-width: var(--col-delete-width);
    width: var(--col-delete-width);
    max-width: var(--col-delete-width);
  }
  .table-wrapper thead .sticky-column-delete {
    z-index: 12; /* Higher than regular headers */
    background-color: var(--primary-color);
  }

  /* Style for inning columns to hide them by default */
  .inning-column {
    display: none;
  }

  /* Style for the currently active inning column */
  .inning-column.active {
    display: table-cell;
  }

  /* Ensure rows with even background color also apply to sticky cells */
  tr:nth-child(even) .sticky-column-1,
  tr:nth-child(even) .sticky-column-2,
  tr:nth-child(even) .sticky-column-3,
  tr:nth-child(even) .sticky-column-delete {
      background-color: #f9f9f9;
  }

  tr:hover .sticky-column-1,
  tr:hover .sticky-column-2,
  tr:hover .sticky-column-3,
  tr:hover .sticky-column-delete {
      background-color: #eef;
  }

  /* --- NEW STYLING FOR JUGADOR SELECT --- */
  .jugador-select {
    padding: 6px 8px; /* Reduced padding */
    border: 1px solid var(--border-color);
    border-radius: 6px;
    width: 100%; /* Fill available space */
    font-size: 13px; /* Slightly smaller font */
    box-sizing: border-box; /* Crucial for width calculation */
    appearance: none; /* Remove default arrow in some browsers */
    background-color: var(--light-color);
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); /* Custom arrow */
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 18px;
    cursor: pointer;
    text-overflow: ellipsis; /* Truncate text */
    overflow: hidden; /* Hide overflow text */
    white-space: nowrap; /* Prevent wrapping inside select */
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }
  .jugador-select option:disabled { /* MODIFIED: Added style for disabled player options */
    color: #ccc;
    background-color: #f9f9f9;
  }

  .jugador-select:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
  }

  /* For positional select, similar styling */
  .posicion-select {
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    width: 100%;
    font-size: 13px;
    box-sizing: border-box;
    appearance: none;
    background-color: var(--light-color);
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 18px;
    cursor: pointer;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }
  .posicion-select option:disabled {
    color: #ccc;
    background-color: #f9f9f9;
  }

  .posicion-select:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
  }

  /* NEW: Delete player button style */
  .delete-player-btn {
    background-color: var(--error-color);
    color: white;
    border: none;
    border-radius: 50%; /* Make it round */
    width: 25px; /* Fixed width and height for a small button */
    height: 25px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease, transform 0.2s ease;
    box-shadow: var(--shadow-light);
  }

  .delete-player-btn:hover {
    background-color: #d32f2f; /* Darker red on hover */
    transform: scale(1.1);
  }

  .agregar-btn {
    margin-top: 20px;
    background-color: var(--primary-color);
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s ease, transform 0.2s ease;
    box-shadow: var(--shadow-light);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .agregar-btn:hover {
    background-color: #303f9f; /* Darker shade of primary */
    transform: translateY(-2px);
  }

  .ining-input {
    width: 50px; /* Slightly narrower to save space */
    padding: 6px; /* Reduced padding */
    border: 1px solid var(--border-color);
    border-radius: 6px;
    text-align: center;
    margin: 3px 0; /* Reduced margin */
    transition: border 0.3s ease, box-shadow 0.3s ease;
    font-size: 13px; /* Smaller font size */
  }

  .ining-input:focus {
    border-color: var(--secondary-color);
    outline: none;
    box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.2);
  }

  .ining-select {
    padding: 6px; /* Reduced padding */
    border: 1px solid var(--border-color);
    border-radius: 6px;
    min-width: 80px; /* Reduced min-width */
    background-color: var(--light-color);
    transition: border 0.3s ease;
    font-size: 13px; /* Smaller font size */
    /* Added for consistency with other selects */
    appearance: none; 
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
    background-repeat: no-repeat;
    background-position: right 6px center; /* Adjusted position */
    background-size: 16px; /* Smaller arrow */
    cursor: pointer;
  }

  .ining-select:focus {
    border-color: var(--secondary-color);
    outline: none;
  }

  .ining-label {
    display: block; /* Change to block for better stacking */
    margin-top: 5px; /* Reduced margin */
    padding: 4px 8px; /* Reduced padding */
    background-color: #f5f5f5; /* Lighter background for label */
    border-radius: 5px;
    font-size: 11px; /* Smaller font size */
    min-width: 60px; /* Reduced min-width */
    word-break: break-all;
    font-weight: 500;
    color: #555;
  }

  .ining-guardar {
    padding: 5px 10px; /* Reduced padding */
    margin-top: 5px; /* Reduced margin */
    background-color: var(--success-color);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px; /* Smaller font size */
    transition: background-color 0.3s ease, transform 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px; /* Reduced gap */
  }

  .ining-guardar:hover {
    background-color: #388e3c; /* Darker success shade */
    transform: translateY(-1px);
  }

  .popup {
    display: none;
    position: fixed; /* Use fixed for better pop-up behavior */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--light-color);
    border: 1px solid var(--border-color);
    padding: 25px;
    z-index: 1000;
    border-radius: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25); /* Stronger shadow for pop-up */
    max-width: 90%;
    width: 400px;
    box-sizing: border-box;
  }

  .ining-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 120px; /* Reduced height */
    justify-content: space-around; /* Distribute space */
  }

  .team-name-input {
    border: none;
    border-bottom: 2px solid var(--primary-color);
    background: transparent;
    font-weight: bold;
    text-align: center;
    font-size: 18px; /* Slightly larger font */
    padding: 5px 8px;
    width: calc(100% - 16px); /* Adjust width for padding */
    color: var(--primary-color);
    transition: border-color 0.3s ease;
    max-width: 250px; /* Limit max width */
  }

  .team-name-input:focus {
    outline: none;
    border-bottom-color: var(--secondary-color);
  }

  .resumen-label {
    font-weight: bold;
    padding: 8px;
    min-width: 30px;
    display: inline-block;
    font-size: 18px; /* Larger score font */
    color: var(--text-color);
  }

  .total-cell {
    font-size: 22px; /* Even larger total score */
    color: var(--primary-color);
    font-weight: 700;
  }

  .action-buttons {
    display: flex;
    gap: 15px; /* Increased gap */
    margin-bottom: 25px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .action-button {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: var(--shadow-light);
  }

  .action-button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
  }

  .export-btn {
    background-color: var(--info-color);
    color: white;
  }

  .export-btn:hover {
    background-color: #1976d2; /* Darker info shade */
  }

  .import-btn {
    background-color: #9c27b0;
    color: white;
  }

  .import-btn:hover {
    background-color: #7b1fa2;
  }

  .finish-btn {
    background-color: var(--error-color);
    color: white;
  }

  .finish-btn:hover {
    background-color: #d32f2f;
  }

  .reset-btn {
    background-color: var(--warning-color);
    color: #333; /* Darker text for warning background */
  }

  .reset-btn:hover {
    background-color: #fbc02d; /* Darker warning shade */
  }

  .registros-container {
    margin-top: 15px;
    max-height: 350px; /* Slightly taller */
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    background-color: white;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
  }

  .registro-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    font-family: 'Roboto Mono', monospace; /* More modern monospace font */
    font-size: 15px;
    color: #444;
  }

  .registro-item:last-child {
    border-bottom: none;
  }

  .inning-extra-btn {
    margin-top: 20px;
    background-color: var(--secondary-color);
    color: white;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s ease, transform 0.2s ease;
    box-shadow: var(--shadow-light);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .inning-extra-btn:hover {
    background-color: #fb8c00; /* Darker secondary shade */
    transform: translateY(-2px);
  }

  .inning-navigation {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    padding: 5px 0;
    background-color: var(--background-color); /* Light background for navigation */
    border-radius: 8px;
  }

  .inning-navigation button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s ease;
  }

  .inning-navigation button:hover {
    background-color: #303f9f;
  }

  .inning-navigation button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .current-inning-display {
    font-size: 16px;
    font-weight: bold;
    color: var(--primary-color);
  }

  /* NEW STYLING FOR GAME DETAILS (made smaller) */
  .game-details-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Adjusted min-width */
    gap: 10px; /* Reduced gap */
    margin-top: 20px; /* Reduced margin */
    padding: 15px; /* Reduced padding */
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: #fbfbfc;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.03);
  }

  .game-detail-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px; /* Reduced padding */
    border: 1px solid #e9e9e9;
    border-radius: 8px;
    background-color: var(--light-color);
    box-shadow: var(--shadow-light);
    transition: transform 0.2s ease;
  }

  .game-detail-item:hover {
    transform: translateY(-2px);
  }

  .game-detail-item strong {
    font-size: 14px; /* Smaller font */
    color: var(--primary-color);
    margin-bottom: 4px; /* Reduced margin */
  }

  .game-detail-item span {
    font-size: 20px; /* Smaller font */
    font-weight: bold;
    color: var(--secondary-color);
  }

  .inning-status-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-weight: bold;
    font-size: 18px; /* Smaller font */
    color: var(--primary-color);
  }
  .inning-status-item .status-text {
    font-size: 24px; /* Smaller font */
    color: var(--secondary-color);
    margin-bottom: 4px; /* Reduced margin */
  }

  .inning-control-buttons {
    display: flex;
    gap: 8px; /* Reduced gap */
    margin-top: 8px; /* Reduced margin */
  }

  .inning-control-buttons button {
    padding: 6px 10px; /* Reduced padding */
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s ease;
    box-shadow: var(--shadow-light);
    font-size: 12px; /* Smaller font */
  }

  .inning-control-buttons .toggle-inning-btn {
    background-color: var(--info-color);
    color: white;
  }

  .inning-control-buttons .toggle-inning-btn:hover {
    background-color: #1976d2;
  }

  .inning-control-buttons .reset-outs-btn {
    background-color: var(--warning-color);
    color: #333;
  }

  .inning-control-buttons .reset-outs-btn:hover {
    background-color: #fbc02d;
  }

  .bases-display {
    display: flex;
    gap: 4px; /* Reduced gap */
    margin-top: 8px; /* Reduced margin */
    font-size: 12px; /* Smaller font */
    font-weight: bold;
    color: #666;
  }
  .bases-display .base {
    width: 22px; /* Smaller size */
    height: 22px; /* Smaller size */
    border: 2px solid var(--primary-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #eee;
    color: #999;
    font-size: 10px; /* Smaller text inside base */
  }
  .bases-display .base.occupied {
    background-color: var(--success-color);
    border-color: var(--success-color);
    color: white;
  }
  .base-control-buttons {
    display: flex;
    gap: 6px; /* Reduced gap */
    margin-top: 8px; /* Reduced margin */
    flex-wrap: wrap;
  }
  .base-control-buttons button {
    padding: 5px 9px; /* Reduced padding */
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px; /* Smaller font */
    transition: background-color 0.2s ease;
    background-color: #5cb85c; /* Greenish for add */
    color: white;
    box-shadow: var(--shadow-light);
  }
  .base-control-buttons button:hover {
    background-color: #4cae4c;
  }
  .base-control-buttons button.clear {
    background-color: #f0ad4e; /* Orange for clear */
  }
  .base-control-buttons button.clear:hover {
    background-color: #ec971f;
  }


  .toggle-details-btn {
    background-color: var(--primary-color);
    color: white;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s ease, transform 0.2s ease;
    box-shadow: var(--shadow-light);
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 20px;
  }
  .toggle-details-btn:hover {
    background-color: #303f9f;
    transform: translateY(-2px);
  }


  /* For hidden content */
  .hidden {
    display: none !important;
  }


  /* --- Responsive Design (Media Queries) --- */

  /* For Tablets and larger phones (e.g., 768px to 1024px) */
  @media (max-width: 1024px) {
    body {
      padding: 15px;
    }

    header {
      padding: 15px;
      flex-direction: column;
      text-align: center;
    }

    header img {
      margin-bottom: 10px;
      margin-right: 0;
    }

    header h1 {
      font-size: 26px;
      margin-bottom: 10px;
    }

    .header-button {
      margin-left: 0;
      margin-top: 10px;
    }

    .section-container {
      padding: 20px;
      margin-bottom: 25px;
    }

    h2 {
      font-size: 22px;
    }

    .form-group {
      grid-template-columns: 1fr; /* Stack inputs vertically */
      gap: 15px;
    }

    table {
      font-size: 13px;
    }

    th,
    td {
      padding: 10px 5px;
    }

    .team-name-input {
      font-size: 16px;
      max-width: 100%;
    }

    .resumen-label {
      font-size: 16px;
    }

    .total-cell {
      font-size: 20px;
    }

    .ining-input,
    .ining-select,
    .ining-guardar {
      font-size: 13px;
      padding: 6px;
    }

    .ining-label {
      font-size: 11px;
      padding: 5px;
    }

    .action-buttons {
      flex-direction: column; /* Stack action buttons */
      gap: 10px;
    }

    .action-button {
      width: 100%; /* Full width for stacked buttons */
      justify-content: center;
    }
    
    .delete-player-btn {
        width: 22px;
        height: 22px;
        font-size: 12px;
    }

    /* Game details container adjustment */
    .game-details-container {
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* Adjusted min-width */
      gap: 8px; /* Reduced gap */
    }
    .game-detail-item strong {
        font-size: 13px; /* Even smaller */
    }
    .game-detail-item span {
        font-size: 18px; /* Even smaller */
    }
    .inning-status-item {
        font-size: 16px; /* Even smaller */
    }
    .inning-status-item .status-text {
        font-size: 22px; /* Even smaller */
    }
    .inning-control-buttons button,
    .base-control-buttons button {
        padding: 5px 8px; /* Even smaller */
        font-size: 11px; /* Even smaller */
    }
    .bases-display .base {
        width: 20px; /* Even smaller */
        height: 20px; /* Even smaller */
        font-size: 9px; /* Even smaller */
    }
  }

  /* For Mobile devices (e.g., up to 767px) */
  @media (max-width: 767px) {
    body {
      padding: 10px;
    }

    header {
      padding: 10px;
    }

    header img {
      height: 50px;
    }

    header h1 {
      font-size: 22px;
    }

    .header-button {
      padding: 8px 12px;
      font-size: 14px;
    }

    .section-container {
      padding: 15px;
      margin-bottom: 20px;
    }

    h2 {
      font-size: 20px;
    }

    .form-group input,
    .form-group select {
      font-size: 14px;
      padding: 10px;
    }

    /* Adjust sticky column widths for smaller screens */
    :root {
      --col1-width: 35px; /* Even smaller for # */
      --col2-width: 90px; /* Smaller Jugador */
      --col3-width: 60px; /* Smaller Posición */
      --col-delete-width: 35px; /* Smaller delete button */
    }

    /* Further adjust padding and font sizes for selects in lineup */
    .jugador-select,
    .posicion-select {
        padding: 4px 6px; /* Even less padding */
        font-size: 12px; /* Smaller font */
        background-size: 14px; /* Smaller arrow */
    }

    /* Adjust inning specific styles */
    .ining-input {
      width: 40px; /* Even narrower */
      padding: 4px; /* Even less padding */
      font-size: 12px; /* Smaller font */
    }
    .ining-select {
      min-width: 60px;
      padding: 4px; /* Even less padding */
      font-size: 12px; /* Smaller font */
      background-size: 14px; /* Smaller arrow */
    }
    .ining-label {
      font-size: 10px; /* Smallest font */
      padding: 3px 6px; /* Minimal padding */
      min-width: 50px; /* Smallest min-width */
    }
    .ining-guardar {
      padding: 4px 8px; /* Smaller button */
      font-size: 11px; /* Smaller font */
      gap: 3px;
    }
    .ining-container {
      min-height: 100px;
    }

    th, td {
      min-width: unset; /* Remove min-width to allow shrinking */
      max-width: unset; /* Remove max-width */
      padding: 8px 3px; /* Reduced padding for all cells */
    }

    .team-name-input {
      font-size: 14px;
      padding: 3px 5px;
    }

    .resumen-label {
      font-size: 14px;
    }

    .total-cell {
      font-size: 18px;
    }

    .agregar-btn,
    .inning-extra-btn {
      padding: 10px 15px;
      font-size: 14px;
    }

    .registros-container {
      max-height: 250px;
      padding: 10px;
    }

    .registro-item {
      font-size: 13px;
      padding: 6px;
    }

    /* Game details container adjustment for small screens */
    .game-details-container {
      grid-template-columns: 1fr; /* Stack details vertically */
      gap: 8px;
    }
    .game-detail-item strong {
        font-size: 12px; /* Smallest */
    }
    .game-detail-item span {
        font-size: 16px; /* Smallest */
    }
    .inning-status-item {
        font-size: 14px; /* Smallest */
    }
    .inning-status-item .status-text {
        font-size: 20px; /* Smallest */
    }
    .inning-control-buttons, .base-control-buttons {
      justify-content: center;
    }
  }

  /* Specific adjustments for Landscape Orientation on Mobile */
  @media (max-width: 820px) and (orientation: landscape) {
    body {
      padding: 15px;
    }

    header {
      flex-direction: row; /* Keep header elements in a row */
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }
    header h1 {
      font-size: 24px;
    }
    header img {
      height: 60px;
      margin-bottom: 0;
    }
    .header-button {
      margin-top: 0;
    }

    /* Adjust column widths slightly for landscape if needed */
    :root {
      --col1-width: 40px;
      --col2-width: 100px; /* Slightly wider than portrait */
      --col3-width: 65px;  /* Slightly wider than portrait */
      --col-delete-width: 40px;
    }

    .jugador-select,
    .posicion-select {
        padding: 5px 7px;
        font-size: 12.5px;
    }

    .ining-input {
      width: 45px;
      padding: 5px;
      font-size: 12.5px;
    }
    .ining-select {
      min-width: 70px;
      padding: 5px;
      font-size: 12.5px;
    }
    .ining-label {
      font-size: 10.5px;
      padding: 4px 7px;
      min-width: 55px;
    }
    .ining-guardar {
      font-size: 11.5px;
      padding: 5px 10px;
    }
    .ining-container {
      min-height: 110px;
    }
  }

</style>
</head>
<body>
  <header>
    <img src="BEISBOL ESTADISTICAS-LOGO.png" alt="Logo Liga Ñanguete" />
    <h1>PARTIDOS - LIGA ÑANGUETE</h1>
    <a href="index.html"><button class="header-button"><i class="fas fa-home"></i> Inicio</button></a>
  </header>

  <div class="section-container">
    <div class="form-group">
      <label for="fecha"><i class="far fa-calendar-alt"></i> Fecha:</label>
      <input type="date" id="fecha" />

      <label for="formato"><i class="fas fa-list-ol"></i> Formato:</label>
      <select id="formato"></select>

      <label for="numeroJuego"><i class="fas fa-hashtag"></i> Número de juego:</label>
      <input type="number" id="numeroJuego" min="1" />
    </div>
  </div>

  <div class="section-container" id="resumen-container">
    <h2><i class="fas fa-clipboard-list"></i> Resumen del Juego</h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Equipo</th>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="text" class="team-name-input" id="local-team-name" placeholder="Nombre local" onchange="actualizarNombreEquipoResumen('local')" /></td>
            <td><div class="resumen-label" id="local-1">0</div></td>
            <td><div class="resumen-label" id="local-2">0</div></td>
            <td><div class="resumen-label" id="local-3">0</div></td>
            <td><div class="resumen-label" id="local-4">0</div></td>
            <td><div class="resumen-label" id="local-5">0</div></td>
            <td><div class="resumen-label" id="local-6">0</div></td>
            <td><div class="resumen-label" id="local-7">0</div></td>
            <td><div class="resumen-label" id="local-8">0</div></td>
            <td><div class="resumen-label" id="local-9">0</div></td>
            <td class="total-cell"><strong id="local-total">0</strong></td>
          </tr>
          <tr>
            <td><input type="text" class="team-name-input" id="visitante-team-name" placeholder="Nombre visitante" onchange="actualizarNombreEquipoResumen('visitante')" /></td>
            <td><div class="resumen-label" id="visitante-1">0</div></td>
            <td><div class="resumen-label" id="visitante-2">0</div></td>
            <td><div class="resumen-label" id="visitante-3">0</div></td>
            <td><div class="resumen-label" id="visitante-4">0</div></td>
            <td><div class="resumen-label" id="visitante-5">0</div></td>
            <td><div class="resumen-label" id="visitante-6">0</div></td>
            <td><div class="resumen-label" id="visitante-7">0</div></td>
            <td><div class="resumen-label" id="visitante-8">0</div></td>
            <td><div class="resumen-label" id="visitante-9">0</div></td>
            <td class="total-cell"><strong id="visitante-total">0</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
    <button class="inning-extra-btn" onclick="agregarInning()"><i class="fas fa-plus"></i> Agregar Inning Extra</button>

    <button class="toggle-details-btn" onclick="toggleGameDetails()"><i class="fas fa-cog"></i> Mostrar Detalles Adicionales</button>

    <div class="game-details-container hidden" id="game-details-container">
        <div class="game-detail-item inning-status-item">
            <strong>Inning Actual</strong>
            <span class="status-text" id="current-inning-status">Top 1</span>
            <div class="inning-control-buttons">
                <button class="toggle-inning-btn" onclick="toggleTopDown()"><i class="fas fa-arrows-alt-v"></i> Cambiar Parte</button>
            </div>
        </div>

        <div class="game-detail-item">
            <strong>Outs</strong>
            <span id="outs-display">0</span>
            <div class="inning-control-buttons">
                <button onclick="addOut()"><i class="fas fa-plus"></i> Out</button>
                <button class="reset-outs-btn" onclick="resetOuts()"><i class="fas fa-undo"></i> Reset</button>
            </div>
        </div>
        
        <div class="game-detail-item">
            <strong>Bases Ocupadas</strong>
            <div class="bases-display">
                <div class="base" id="base1">1B</div>
                <div class="base" id="base2">2B</div>
                <div class="base" id="base3">3B</div>
            </div>
            <div class="base-control-buttons">
                <button onclick="toggleBase(1)">1B</button>
                <button onclick="toggleBase(2)">2B</button>
                <button onclick="toggleBase(3)">3B</button>
                <button class="clear" onclick="clearBases()">Limpiar</button>
            </div>
        </div>

        <div class="game-detail-item">
            <strong>Hits (H)</strong>
            <span>Local: <span id="local-hits">0</span></span>
            <span>Visitante: <span id="visitante-hits">0</span></span>
        </div>

        <div class="game-detail-item">
            <strong>Errores (E)</strong>
            <span>Local: <span id="local-errors">0</span></span>
            <span>Visitante: <span id="visitante-errors">0</span></span>
        </div>
        
        <div class="game-detail-item">
            <strong>Jonrones (HR)</strong>
            <span>Local: <span id="local-hr">0</span></span>
            <span>Visitante: <span id="visitante-hr">0</span></span>
        </div>

        <div class="game-detail-item">
            <strong>Ponches (K)</strong>
            <span>Local: <span id="local-k">0</span></span>
            <span>Visitante: <span id="visitante-k">0</span></span>
        </div>
    </div>
  </div>

  <div class="section-container">
    <div class="lineup-header-container">
      <h2><i class="fas fa-users"></i> Lineup - <input type="text" class="team-name-input" id="lineup-local-name" placeholder="Nombre local" onchange="actualizarNombreEquipoLineup('local')" /></h2>
      <div class="inning-navigation">
        <button onclick="showPrevInning()"><i class="fas fa-chevron-left"></i></button>
        <span class="current-inning-display" id="current-inning-display">Inning 1</span>
        <button onclick="showNextInning()"><i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
    <div class="table-wrapper">
      <table id="lineup-local">
        <thead>
          <tr>
            <th class="sticky-column-1">#</th>
            <th class="sticky-column-2">Jugador</th>
            <th class="sticky-column-3">Posición</th>
            <th class="sticky-column-delete"></th>
            </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button class="agregar-btn" onclick="agregarJugador('lineup-local')"><i class="fas fa-plus"></i> Agregar Jugador</button>
  </div>

  <div class="section-container">
    <div class="lineup-header-container">
      <h2><i class="fas fa-users"></i> Lineup - <input type="text" class="team-name-input" id="lineup-visitante-name" placeholder="Nombre visitante" onchange="actualizarNombreEquipoLineup('visitante')" /></h2>
      <div class="inning-navigation" style="display: none;">
        </div>
    </div>
    <div class="table-wrapper">
      <table id="lineup-visitante">
        <thead>
          <tr>
            <th class="sticky-column-1">#</th>
            <th class="sticky-column-2">Jugador</th>
            <th class="sticky-column-3">Posición</th>
            <th class="sticky-column-delete"></th>
            </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button class="agregar-btn" onclick="agregarJugador('lineup-visitante')"><i class="fas fa-plus"></i> Agregar Jugador</button>
  </div>

  <div class="section-container">
    <h2><i class="fas fa-history"></i> Registros del Juego</h2>
    
    <div class="action-buttons">
      <button class="action-button export-btn" onclick="exportarJuegoCSV()">
        <i class="fas fa-file-export"></i> Exportar Juego CSV
      </button>
      <button class="action-button import-btn" onclick="document.getElementById('file-input').click()">
        <i class="fas fa-file-import"></i> Importar Juego CSV
        <input type="file" id="file-input" accept=".csv" style="display: none;" onchange="importarJuegoCSV(event)">
      </button>
      <button class="action-button reset-btn" onclick="reiniciarPartido()">
        <i class="fas fa-redo"></i> Reiniciar Partido
      </button>
      <button class="action-button finish-btn" onclick="terminarPartido()">
        <i class="fas fa-flag-checkered"></i> Terminar Partido
      </button>
    </div>
    
    <div class="registros-container" id="registros-container">
      </div>
  </div>

  <div id="popup" class="popup"></div>

  <script>
    const posiciones = ["P", "C", "1B", "2B", "3B", "SS", "LF", "CF", "RF", "DH"];
    let registrosJuego = [];
    let maxInnings = 9;
    let currentInning = 1; // Single variable for current inning, applied to both teams
    let isTopInning = true; // True for visitors (Top), false for local (Down)
    let outs = 0; // Current outs for the active half-inning
    let bases = [false, false, false]; // [1st, 2nd, 3rd]

    let partidoData = {
      fecha: "",
      formato: "",
      numeroJuego: "",
      localTeamName: "Local",
      visitanteTeamName: "Visitante",
      registros: [],
      maxInnings: 9,
      currentInning: 1, // Update to single currentInning
      isTopInning: true,
      outs: 0, // Current outs
      bases: [false, false, false],
      showDetails: false // To control visibility of new details section
    };

    // Función para obtener las jugadas desde localStorage
    function obtenerJugadas() {
      const jugadasData = localStorage.getItem("jugadasData");
      if (jugadasData) {
        const jugadas = JSON.parse(jugadasData);
        return jugadas.map(jugada => ({
          nombre: jugada.jugada || jugada.nombre,
          descripcion: jugada.descripcion
        }));
      }
      return [];
    }

    // Función para obtener los jugadores desde localStorage
    function obtenerJugadores() {
        const jugadoresData = localStorage.getItem("jugadoresData");
        return jugadoresData ? JSON.parse(jugadoresData) : [];
    }

    // Inicializar localStorage con datos de ejemplo si está vacío
    function inicializarDatosEjemplo() {
      if (!localStorage.getItem("jugadasData")) {
        const jugadasEjemplo = [
          { jugada: "H", nombre: "H", descripcion: "Hit (generico)" },
          { jugada: "H1", nombre: "H1", descripcion: "Sencillo" },
          { jugada: "H2", nombre: "H2", descripcion: "Doble" },
          { jugada: "H3", nombre: "H3", descripcion: "Triple" },
          { jugada: "HR", nombre: "HR", descripcion: "Home Run" },
          { jugada: "A", nombre: "A", descripcion: "Carrera Anotada" },
          { jugada: "CI", nombre: "CI", descripcion: "Carrera Impulsada" },
          { jugada: "P", nombre: "P", descripcion: "Ponche" }, // Changed from K to P
          { jugada: "BB", nombre: "BB", descripcion: "Base por Bolas" },
          { jugada: "E-D", nombre: "E-D", descripcion: "Error de Defensor" }, // Changed from E to E-D
          { jugada: "O", nombre: "O", descripcion: "Out (generico)" },
          { jugada: "AR", nombre: "AR", descripcion: "Out por Regla" },
          { jugada: "FS", nombre: "FS", descripcion: "Foul Strike Out" }
        ];
        localStorage.setItem("jugadasData", JSON.stringify(jugadasEjemplo));
      }
      
      if (!localStorage.getItem("jugadoresData")) {
        localStorage.setItem("jugadoresData", JSON.stringify([
          { nombre: "Juan Pérez", equipo: "Local" },
          { nombre: "Pedro González", equipo: "Local" },
          { nombre: "María Fernández", equipo: "Local", posicion: "P" }, // Added a pitcher for local
          { nombre: "Luis Rodríguez", equipo: "Visitante" },
          { nombre: "Ana García", equipo: "Visitante", posicion: "P" }, // Added a pitcher for visitante
          { nombre: "Carlos Sánchez", equipo: "Local" },
          { nombre: "Marta Díaz", equipo: "Visitante" }
        ]));
      }
      
      if (!localStorage.getItem("formatosData")) {
        localStorage.setItem("formatosData", JSON.stringify([
          { formato: "7 Entradas", descripcion: "7 entradas" },
          { formato: "9 Entradas", descripcion: "9 entradas" }
        ]));
      }
    }

    function cargarFormatos() {
      const select = document.getElementById("formato");
      const formatosData = localStorage.getItem("formatosData");
      if (formatosData) {
        const formatos = JSON.parse(formatosData);
        select.innerHTML = "";
        formatos.forEach(f => {
          const option = document.createElement("option");
          option.value = f.formato;
          option.textContent = f.formato;
          select.appendChild(option);
        });
      }
    }

    // --- MODIFICATION START: Position Management ---
    function updatePositionAvailability(tablaId) {
        const tabla = document.getElementById(tablaId);
        if (!tabla) return;
        const positionSelects = tabla.querySelectorAll("tbody .posicion-select");

        const allSelectedNonDHPositionsInTable = new Set();
        positionSelects.forEach(sel => {
            if (sel.value && sel.value !== "DH" && sel.value !== "") {
                allSelectedNonDHPositionsInTable.add(sel.value);
            }
        });

        positionSelects.forEach(currentSelect => {
            const currentValueInThisSelect = currentSelect.value;
            Array.from(currentSelect.options).forEach(option => {
                if (option.value === "" || option.value === "DH") {
                    option.disabled = false; // Always enable placeholder and DH
                } else {
                    if (allSelectedNonDHPositionsInTable.has(option.value) && option.value !== currentValueInThisSelect) {
                        option.disabled = true;
                    } else {
                        option.disabled = false;
                    }
                }
            });
        });
    }

    function initializePositionSelectListeners(tablaId) {
        const tabla = document.getElementById(tablaId);
        if (!tabla) return;
        const positionSelects = tabla.querySelectorAll("tbody .posicion-select");

        const changeHandler = function() { 
            updatePositionAvailability(tablaId); 
        };

        positionSelects.forEach(select => {
            if (select._myPositionChangeHandler) {
                select.removeEventListener('change', select._myPositionChangeHandler);
            }
            select.addEventListener('change', changeHandler);
            select._myPositionChangeHandler = changeHandler; 
        });
        updatePositionAvailability(tablaId); 
    }
    // --- MODIFICATION END: Position Management ---

    // --- MODIFICATION START: Player Name Management ---
    function updatePlayerNameAvailability() {
        const allPlayerSelects = document.querySelectorAll("#lineup-local tbody .jugador-select, #lineup-visitante tbody .jugador-select");
        const globallySelectedPlayerNames = new Set();

        allPlayerSelects.forEach(select => {
            if (select.value && select.value !== "") { 
                globallySelectedPlayerNames.add(select.value);
            }
        });

        allPlayerSelects.forEach(currentSelect => {
            const currentValueInThisSelect = currentSelect.value;
            Array.from(currentSelect.options).forEach(option => {
                if (option.value === "") { 
                    option.disabled = false;
                } else {
                    if (globallySelectedPlayerNames.has(option.value) && option.value !== currentValueInThisSelect) {
                        option.disabled = true;
                    } else {
                        option.disabled = false;
                    }
                }
            });
        });
    }

    function initializePlayerNameSelectListeners() {
        const allPlayerSelects = document.querySelectorAll("#lineup-local tbody .jugador-select, #lineup-visitante tbody .jugador-select");

        const changeHandler = function() {
            updatePlayerNameAvailability();
        };

        allPlayerSelects.forEach(select => {
            if (select._myPlayerNameChangeHandler) {
                select.removeEventListener('change', select._myPlayerNameChangeHandler);
            }
            select.addEventListener('change', changeHandler);
            select._myPlayerNameChangeHandler = changeHandler;
        });
        updatePlayerNameAvailability(); 
    }
    // --- MODIFICATION END: Player Name Management ---


    function agregarJugador(tablaId) {
      const tabla = document.getElementById(tablaId);
      const tbody = tabla.querySelector("tbody");
      const jugadoresData = obtenerJugadores();
      const jugadasData = obtenerJugadas();
      
      if (jugadasData.length === 0) {
        alert("No hay jugadas registradas. Por favor, agregue jugadas primero.");
        return;
      }

      const tr = document.createElement("tr");
      const index = tbody.rows.length + 1; 

      const opcionesJugadores = jugadoresData.map(j => `<option value="${j.nombre}">${j.nombre}</option>`).join("");
      const opcionesPosiciones = posiciones.map(p => `<option value="${p}">${p}</option>`).join("");
      const opcionesJugadas = jugadasData.map(j => `<option value="${j.nombre}">${j.nombre}</option>`).join("");

      let celdasIning = "";
      for (let i = 0; i < maxInnings; i++) {
        const inningNumber = i + 1;
        const isActiveInning = (inningNumber === currentInning);
        celdasIning += `
          <td class="inning-column inning-${inningNumber} ${isActiveInning ? 'active' : ''}">
            <div class="ining-container">
              <select class="ining-select">
                <option value="">--</option>
                ${opcionesJugadas}
              </select>
              <input type="number" class="ining-input" value="1" min="-999" max="999">
              <button class="ining-guardar" onclick="guardarJugada(this, '${tablaId}', ${inningNumber})"><i class="fas fa-save"></i> Guardar</button>
              <div class="ining-label"></div>
              <input type="hidden" class="pitcher-name-input" value="">
            </div>
          </td>`;
      }

      tr.innerHTML = `
        <td class="sticky-column-1">${index}</td>
        <td class="sticky-column-2"><select class="jugador-select"><option value="">Seleccionar</option>${opcionesJugadores}</select></td>
        <td class="sticky-column-3"><select class="posicion-select"><option value="">--</option>${opcionesPosiciones}</select></td>
        <td class="sticky-column-delete">
            <button class="delete-player-btn" onclick="eliminarJugador(this, '${tablaId}')">X</button>
        </td>
        ${celdasIning}
      `;
      tbody.appendChild(tr);
      initializePositionSelectListeners(tablaId); 
      initializePlayerNameSelectListeners(); // MODIFIED: Initialize player name availability
      guardarEstadoPartido(); 
    }

    function eliminarJugador(btn, tablaId) {
        if (!confirm("¿Estás seguro de que quieres eliminar a este jugador del lineup? Se perderán todas sus jugadas registradas en este partido.")) {
            return;
        }

        const rowToDelete = btn.closest("tr");
        const tbody = rowToDelete.parentElement;
        const jugadorSelect = rowToDelete.querySelector(".jugador-select"); 
        const nombreJugadorEliminado = jugadorSelect ? jugadorSelect.value : "";

        tbody.removeChild(rowToDelete);

        Array.from(tbody.children).forEach((row, idx) => {
            row.cells[0].textContent = idx + 1; 
        });

        const equipoDelLineup = tablaId.includes('local') ? 
            (document.getElementById('lineup-local-name').value || 'Local') : 
            (document.getElementById('lineup-visitante-name').value || 'Visitante');

        registrosJuego = registrosJuego.filter(registro => {
            return !(
                (registro.equipo === equipoDelLineup && registro.jugador === nombreJugadorEliminado) ||
                (registro.pitcherResponsable === nombreJugadorEliminado) 
            );
        });

        actualizarRegistrosUI();
        actualizarResumenGlobal(); 
        initializePositionSelectListeners(tablaId); 
        initializePlayerNameSelectListeners(); // MODIFIED: Update player name availability
        guardarEstadoPartido(); 
    }

    function obtenerPitcherDelEquipo(equipoTablaId) {
        const otroEquipoTablaId = (equipoTablaId === 'lineup-local') ? 'lineup-visitante' : 'lineup-local';
        const tablaOtroEquipo = document.getElementById(otroEquipoTablaId);
        const filasOtroEquipo = tablaOtroEquipo.querySelectorAll("tbody tr");
        let pitcherNombre = "Desconocido";
        for (const row of filasOtroEquipo) {
            const posicionSelect = row.querySelector(".posicion-select");
            const jugadorSelect = row.querySelector(".jugador-select");
            if (posicionSelect && jugadorSelect && posicionSelect.value === "P") {
                pitcherNombre = jugadorSelect.value;
                break; 
            }
        }
        return pitcherNombre;
    }

    function guardarJugada(btn, tablaId, inning) {
      const container = btn.parentElement;
      const select = container.querySelector(".ining-select");
      const input = container.querySelector(".ining-input");
      const label = container.querySelector(".ining-label");
      const pitcherInput = container.querySelector(".pitcher-name-input");
      const jugada = select.value;
      const cantidad = parseInt(input.value);
      if (jugada && !isNaN(cantidad)) {
        const pitcherResponsable = obtenerPitcherDelEquipo(tablaId);
        pitcherInput.value = pitcherResponsable;
        if (label.textContent) {
          label.textContent += `+${cantidad}${jugada}`;
        } else {
          label.textContent = `${cantidad}${jugada}`;
        }
        const row = btn.closest("tr");
        const jugadorSelect = row.querySelector(".jugador-select");
        const posicionSelect = row.querySelector(".posicion-select");
        const jugador = jugadorSelect ? jugadorSelect.value : "Desconocido";
        const posicion = posicionSelect ? posicionSelect.value : "Desconocido";
        const equipo = tablaId.includes("local") ? 
          document.getElementById("lineup-local-name").value || "Local" : 
          document.getElementById("lineup-visitante-name").value || "Visitante";
        const registro = {
          fecha: document.getElementById("fecha").value,
          formato: document.getElementById("formato").value,
          numeroJuego: document.getElementById("numeroJuego").value,
          equipo: equipo,
          jugador: jugador,
          posicion: posicion,
          inning: inning,
          jugada: jugada, 
          cantidad: cantidad,
          pitcherResponsable: pitcherResponsable, 
          timestamp: new Date().toISOString()
        };
        registrosJuego.push(registro);
        if (['O', 'AR', 'FS', 'P'].includes(jugada)) { 
            addOut(cantidad); 
        }
        select.value = "";
        input.value = "1";
        actualizarRegistrosUI();
        actualizarResumenGlobal(); 
        guardarEstadoPartido();
      } else {
        alert("Por favor, seleccione una jugada y asegúrese de que la cantidad sea un número válido.");
      }
    }

    function actualizarResumenGlobal() {
      actualizarResumenIndividual("local");
      actualizarResumenIndividual("visitante");
      actualizarEstadisticasAdicionales();
    }

    function actualizarResumenIndividual(equipo) {
      const tablaId = `lineup-${equipo}`;
      const tabla = document.getElementById(tablaId);
      if (!tabla) return; 
      const tbody = tabla.querySelector("tbody");
      const sumasInnings = {};
      for (let i = 1; i <= maxInnings; i++) {
        sumasInnings[i] = 0;
      }
      tbody.querySelectorAll("tr").forEach(row => {
        for (let i = 4; i < 4 + maxInnings; i++) { 
          const cell = row.cells[i];
          if (cell) {
            const label = cell.querySelector(".ining-label");
            if (label && label.textContent) {
              const regex = /([+-]?\d+)A/g; 
              let match;
              while ((match = regex.exec(label.textContent)) !== null) {
                const inning = i - 3; 
                sumasInnings[inning] += parseInt(match[1]);
              }
            }
          }
        }
      });
      for (let inning = 1; inning <= maxInnings; inning++) {
        const label = document.getElementById(`${equipo}-${inning}`);
        if (label) {
          label.textContent = sumasInnings[inning] || "0";
        }
      }
      const total = Object.values(sumasInnings).reduce((sum, val) => sum + val, 0);
      document.getElementById(`${equipo}-total`).textContent = total;
    }

    function actualizarEstadisticasAdicionales() {
        const localTeamName = document.getElementById("lineup-local-name").value || "Local";
        const visitanteTeamName = document.getElementById("lineup-visitante-name").value || "Visitante";
        let localHits = 0, visitanteHits = 0, localErrors = 0, visitanteErrors = 0;
        let localHR = 0, visitanteHR = 0, localK = 0, visitanteK = 0;

        registrosJuego.forEach(registro => {
            const cantidad = parseInt(registro.cantidad);
            if (isNaN(cantidad)) return;
            const isLocalTeam = registro.equipo === localTeamName;
            const isVisitanteTeam = registro.equipo === visitanteTeamName;

            if (['H1', 'H2', 'H3', 'HR'].includes(registro.jugada)) {
                if (isLocalTeam) localHits += cantidad; else if (isVisitanteTeam) visitanteHits += cantidad;
            }
            if (registro.jugada === "HR") {
                if (isLocalTeam) localHR += cantidad; else if (isVisitanteTeam) visitanteHR += cantidad;
            }
            if (registro.jugada === "P") { 
                if (isLocalTeam) localK += cantidad; else if (isVisitanteTeam) visitanteK += cantidad;
            }
            if (registro.jugada === "E-D") { 
                if (isTopInning && !isVisitanteTeam) { // Visitor batting, local defending (error for local)
                    localErrors += cantidad;
                } else if (!isTopInning && !isLocalTeam) { // Local batting, visitor defending (error for visitor)
                     visitanteErrors += cantidad;
                } else if (isTopInning && isLocalTeam) { // Visitor batting, error on local player (counts for local)
                    localErrors += cantidad;
                } else if (!isTopInning && isVisitanteTeam) { // Local batting, error on visitor player (counts for visitor)
                    visitanteErrors += cantidad;
                }
            }
        });
        document.getElementById('local-hits').textContent = localHits;
        document.getElementById('visitante-hits').textContent = visitanteHits;
        document.getElementById('local-errors').textContent = localErrors;
        document.getElementById('visitante-errors').textContent = visitanteErrors;
        document.getElementById('local-hr').textContent = localHR;
        document.getElementById('visitante-hr').textContent = visitanteHR;
        document.getElementById('local-k').textContent = localK;
        document.getElementById('visitante-k').textContent = visitanteK;
        const inningStatusElement = document.getElementById('current-inning-status');
        if (inningStatusElement) {
            inningStatusElement.textContent = `${isTopInning ? 'Top' : 'Down'} ${currentInning}`;
        }
        document.getElementById('outs-display').textContent = outs;
        updateBasesDisplay();
    }

    function actualizarNombreEquipoLineup(tipo) {
      const input = document.getElementById(`lineup-${tipo}-name`);
      const resumenInput = document.getElementById(`${tipo}-team-name`);
      if (input && resumenInput) {
        resumenInput.value = input.value;
      }
      guardarEstadoPartido();
    }

    function actualizarNombreEquipoResumen(tipo) {
      const input = document.getElementById(`${tipo}-team-name`);
      const lineupInput = document.getElementById(`lineup-${tipo}-name`); 
      if (input && lineupInput) {
        lineupInput.value = input.value;
      }
      guardarEstadoPartido();
    }

    function actualizarRegistrosUI() {
      const container = document.getElementById("registros-container");
      container.innerHTML = "";
      registrosJuego.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      registrosJuego.forEach(registro => {
        const registroElement = document.createElement("div");
        registroElement.className = "registro-item";
        registroElement.textContent = `[${new Date(registro.timestamp).toLocaleTimeString()}] ${registro.equipo} - ${registro.jugador} (${registro.posicion}): Inning ${registro.inning} - ${registro.cantidad}${registro.jugada} (vs P: ${registro.pitcherResponsable || 'N/A'})`;
        container.appendChild(registroElement);
      });
    }

    function exportarJuegoCSV() {
      if (registrosJuego.length === 0) {
        alert("No hay registros para exportar");
        return;
      }
      const allKeys = new Set();
      registrosJuego.forEach(record => Object.keys(record).forEach(key => allKeys.add(key)));
      const headers = Array.from(allKeys);
      let csv = headers.join(",") + "\n";
      registrosJuego.forEach(registro => {
        const values = headers.map(header => {
          let value = registro[header] || ""; 
          if (typeof value === "string" && value.includes(",")) {
            value = `"${value.replace(/"/g, '""')}"`; 
          }
          return value;
        });
        csv += values.join(",") + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `partido_${document.getElementById("fecha").value}_${document.getElementById("local-team-name").value || "Local"}_vs_${document.getElementById("visitante-team-name").value || "Visitante"}.csv`);
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function importarJuegoCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const contents = e.target.result;
        const lines = contents.split("\n");
        if (lines.length < 2) {
          alert("El archivo CSV no contiene datos válidos");
          return;
        }
        registrosJuego = [];
        const headers = lines[0].split(",").map(h => h.trim());
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = lines[i].split(",").map(v => v.trim().replace(/^"(.*)"$/, '$1').replace(/""/g, '"')); 
          const registro = {};
          headers.forEach((header, index) => {
            registro[header] = values[index] || "";
            if (header === 'cantidad' && !isNaN(parseInt(registro[header]))) {
                registro[header] = parseInt(registro[header]);
            }
          });
          registrosJuego.push(registro);
        }
        reconstruirDesdeRegistros();
        actualizarRegistrosUI();
        guardarEstadoPartido();
        alert(`Se importaron ${registrosJuego.length} registros correctamente`);
      };
      reader.readAsText(file);
      event.target.value = "";
    }

    function reconstruirDesdeRegistros() {
      if (registrosJuego.length === 0) {
        reiniciarPartido(); 
        return;
      }
      const primerRegistro = registrosJuego[0];
      document.getElementById("fecha").value = primerRegistro.fecha || "";
      document.getElementById("formato").value = primerRegistro.formato || "";
      document.getElementById("numeroJuego").value = primerRegistro.numeroJuego || "";
      const equipos = {};
      registrosJuego.forEach(registro => {
        if (!equipos[registro.equipo]) equipos[registro.equipo] = {};
        if (!equipos[registro.equipo][registro.jugador]) {
          equipos[registro.equipo][registro.jugador] = { posicion: registro.posicion, innings: {} };
        }
        if (!equipos[registro.equipo][registro.jugador].innings[registro.inning]) {
          equipos[registro.equipo][registro.jugador].innings[registro.inning] = [];
        }
        equipos[registro.equipo][registro.jugador].innings[registro.inning].push({
          jugada: registro.jugada, cantidad: registro.cantidad, pitcherResponsable: registro.pitcherResponsable 
        });
      });
      maxInnings = Math.max(...registrosJuego.map(r => parseInt(r.inning)).filter(Number.isFinite), 9);
      reconstruirTablaResumen();

      let firstTeamAssignedAsLocal = false;
      for (const equipoNombre in equipos) {
          let esLocal = partidoData.localTeamName === equipoNombre || 
                        (document.getElementById("lineup-local-name").value && equipoNombre === document.getElementById("lineup-local-name").value);

          if (!partidoData.localTeamName && !document.getElementById("lineup-local-name").value && !firstTeamAssignedAsLocal) {
              esLocal = true;
              firstTeamAssignedAsLocal = true; 
          } else if (!partidoData.visitanteTeamName && !document.getElementById("lineup-visitante-name").value && firstTeamAssignedAsLocal && !esLocal) {
              // If local is already assigned, and this is a different team, it's visitor.
          }


        const tablaId = esLocal ? "lineup-local" : "lineup-visitante";
        const nombreInputId = esLocal ? "lineup-local-name" : "lineup-visitante-name";
        const resumenInputId = esLocal ? "local-team-name" : "visitante-team-name";
        
        document.getElementById(nombreInputId).value = equipoNombre;
        document.getElementById(resumenInputId).value = equipoNombre;
        if (esLocal) partidoData.localTeamName = equipoNombre; else partidoData.visitanteTeamName = equipoNombre;

        const tbody = document.getElementById(tablaId).querySelector("tbody");
        tbody.innerHTML = ""; 
        const jugadoresEnLocalStorage = obtenerJugadores();
        let playerIndex = 1; 
        for (const jugadorNombre in equipos[equipoNombre]) {
          const datosJugador = equipos[equipoNombre][jugadorNombre];
          const tr = document.createElement("tr");
          let celdasIning = "";
          const jugadasOptions = obtenerJugadas().map(j => `<option value="${j.nombre}">${j.nombre}</option>`).join("");
          for (let i = 1; i <= maxInnings; i++) {
            const jugadasInning = datosJugador.innings[i] || [];
            const labelText = jugadasInning.map(j => `${j.cantidad}${j.jugada}`).join("+");
            const pitcherInThisInning = jugadasInning.length > 0 ? jugadasInning[jugadasInning.length - 1].pitcherResponsable : "";
            const isActiveInning = (i === currentInning); 
            celdasIning += `
              <td class="inning-column inning-${i} ${isActiveInning ? 'active' : ''}">
                <div class="ining-container">
                  <select class="ining-select"><option value="">--</option>${jugadasOptions}</select>
                  <input type="number" class="ining-input" value="1" min="-999" max="999">
                  <button class="ining-guardar" onclick="guardarJugada(this, '${tablaId}', ${i})"><i class="fas fa-save"></i> Guardar</button>
                  <div class="ining-label">${labelText}</div>
                  <input type="hidden" class="pitcher-name-input" value="${pitcherInThisInning}">
                </div>
              </td>`;
          }
          const opcionesJugadores = jugadoresEnLocalStorage.map(j => `<option value="${j.nombre}" ${j.nombre === jugadorNombre ? 'selected' : ''}>${j.nombre}</option>`).join("");
          const opcionesPosiciones = posiciones.map(p => `<option value="${p}" ${p === datosJugador.posicion ? 'selected' : ''}>${p}</option>`).join("");
          tr.innerHTML = `
            <td class="sticky-column-1">${playerIndex++}</td>
            <td class="sticky-column-2"><select class="jugador-select"><option value="">Seleccionar</option>${opcionesJugadores}</select></td>
            <td class="sticky-column-3"><select class="posicion-select"><option value="">--</option>${opcionesPosiciones}</select></td>
            <td class="sticky-column-delete">
                <button class="delete-player-btn" onclick="eliminarJugador(this, '${tablaId}')">X</button>
            </td>
            ${celdasIning}
          `;
          tbody.appendChild(tr);
        }
      }
      initializePositionSelectListeners("lineup-local");   
      initializePositionSelectListeners("lineup-visitante"); 
      initializePlayerNameSelectListeners(); // MODIFIED: Initialize player name availability
      actualizarResumenGlobal(); 
      showInning(currentInning); 
    }

    function reconstruirTablaResumen() {
      const resumenTabla = document.querySelector("#resumen-container table");
      const resumenThead = resumenTabla.querySelector("thead tr");
      const resumenTbodyLocal = resumenTabla.querySelector("tbody tr:first-child");
      const resumenTbodyVisitante = resumenTabla.querySelector("tbody tr:last-child");
      for (let i = resumenThead.children.length - 2; i > 0; i--) { 
        resumenThead.removeChild(resumenThead.children[i]);
      }
      for (let i = resumenTbodyLocal.children.length - 2; i > 0; i--) {
        resumenTbodyLocal.removeChild(resumenTbodyLocal.children[i]);
      }
      for (let i = resumenTbodyVisitante.children.length - 2; i > 0; i--) {
        resumenTbodyVisitante.removeChild(resumenTbodyVisitante.children[i]);
      }
      for (let i = 1; i <= maxInnings; i++) {
        const th = document.createElement("th");
        th.textContent = i;
        resumenThead.insertBefore(th, resumenThead.lastElementChild);
        const localTd = document.createElement("td");
        localTd.innerHTML = `<div class="resumen-label" id="local-${i}">0</div>`;
        resumenTbodyLocal.insertBefore(localTd, resumenTbodyLocal.lastElementChild);
        const visitanteTd = document.createElement("td");
        visitanteTd.innerHTML = `<div class="resumen-label" id="visitante-${i}">0</div>`;
        resumenTbodyVisitante.insertBefore(visitanteTd, resumenTbodyVisitante.lastElementChild);
      }
      document.getElementById("local-team-name").value = partidoData.localTeamName || "Local";
      document.getElementById("visitante-team-name").value = partidoData.visitanteTeamName || "Visitante";
    }

    function reconstruirLineupInnings(tablaId) {
        const tabla = document.getElementById(tablaId);
        const theadRow = tabla.querySelector("thead tr");
        const tbodyRows = tabla.querySelectorAll("tbody tr");
        const firstInningHeaderIndex = 4;
        while (theadRow.children.length > firstInningHeaderIndex) { 
            theadRow.removeChild(theadRow.lastElementChild); 
        }
        tbodyRows.forEach(row => {
            while (row.children.length > 4) { 
                row.removeChild(row.lastElementChild);
            }
        });
        for (let i = 1; i <= maxInnings; i++) {
            const newTh = document.createElement("th");
            newTh.textContent = i;
            newTh.classList.add('inning-column', `inning-${i}`);
            theadRow.appendChild(newTh);
        }
        const jugadasOptions = obtenerJugadas().map(j => `<option value="${j.nombre}">${j.nombre}</option>`).join("");
        tbodyRows.forEach(row => {
            for (let i = 1; i <= maxInnings; i++) {
                const nuevaCelda = document.createElement("td");
                nuevaCelda.classList.add('inning-column', `inning-${i}`);
                nuevaCelda.innerHTML = `
                    <div class="ining-container">
                        <select class="ining-select"><option value="">--</option>${jugadasOptions}</select>
                        <input type="number" class="ining-input" value="1" min="-999" max="999">
                        <button class="ining-guardar" onclick="guardarJugada(this, '${tablaId}', ${i})"><i class="fas fa-save"></i> Guardar</button>
                        <div class="ining-label"></div>
                        <input type="hidden" class="pitcher-name-input" value=""></div>`;
                row.appendChild(nuevaCelda);
            }
        });
        actualizarResumenGlobal();
        showInning(currentInning);
        updatePositionAvailability(tablaId); 
    }

    function agregarInning() {
      maxInnings++;
      const resumenThead = document.querySelector("#resumen-container table thead tr");
      const newTh = document.createElement("th");
      newTh.textContent = maxInnings;
      resumenThead.insertBefore(newTh, resumenThead.lastElementChild);
      const resumenLocalRow = document.querySelector("#resumen-container table tbody tr:first-child");
      const newLocalCell = document.createElement("td");
      newLocalCell.innerHTML = `<div class="resumen-label" id="local-${maxInnings}">0</div>`;
      resumenLocalRow.insertBefore(newLocalCell, resumenLocalRow.lastElementChild);
      const resumenVisitanteRow = document.querySelector("#resumen-container table tbody tr:last-child");
      const newVisitanteCell = document.createElement("td");
      newVisitanteCell.innerHTML = `<div class="resumen-label" id="visitante-${maxInnings}">0</div>`;
      resumenVisitanteRow.insertBefore(newVisitanteCell, resumenVisitanteRow.lastElementChild);
      const lineups = ["lineup-local", "lineup-visitante"];
      lineups.forEach(lineupId => {
        const tabla = document.getElementById(lineupId);
        const theadRow = tabla.querySelector("thead tr");
        const tbodyRows = tabla.querySelectorAll("tbody tr");
        const newInningTh = document.createElement("th");
        newInningTh.textContent = maxInnings;
        newInningTh.classList.add('inning-column', `inning-${maxInnings}`); 
        theadRow.appendChild(newInningTh);
        tbodyRows.forEach(row => {
          const nuevaCelda = document.createElement("td");
          nuevaCelda.classList.add('inning-column', `inning-${maxInnings}`); 
          nuevaCelda.innerHTML = `
            <div class="ining-container">
              <select class="ining-select"><option value="">--</option>${obtenerJugadas().map(j => `<option value="${j.nombre}">${j.nombre}</option>`).join("")}</select>
              <input type="number" class="ining-input" value="1" min="-999" max="999">
              <button class="ining-guardar" onclick="guardarJugada(this, '${lineupId}', ${maxInnings})"><i class="fas fa-save"></i> Guardar</button>
              <div class="ining-label"></div>
              <input type="hidden" class="pitcher-name-input" value=""></div>`;
          row.appendChild(nuevaCelda);
        });
      });
      showInning(currentInning);
      guardarEstadoPartido();
    }

    function reiniciarPartido() {
      if (confirm("¿Estás seguro de que quieres reiniciar el partido? Se perderán todos los registros de jugadas, pero los jugadores en el lineup se mantendrán.")) {
        document.getElementById("fecha").value = new Date().toISOString().split('T')[0];
        document.getElementById("formato").value = "";
        document.getElementById("numeroJuego").value = "";
        document.getElementById("local-team-name").value = "Local";
        document.getElementById("visitante-team-name").value = "Visitante";
        document.getElementById("lineup-local-name").value = "Local";
        document.getElementById("lineup-visitante-name").value = "Visitante";
        maxInnings = 9; 
        currentInning = 1;
        isTopInning = true;
        outs = 0; 
        bases = [false, false, false]; 
        reconstruirTablaResumen();
        reconstruirLineupInnings("lineup-local");
        reconstruirLineupInnings("lineup-visitante");
        registrosJuego = [];
        document.getElementById("registros-container").innerHTML = "";
        actualizarResumenGlobal(); 
        initializePositionSelectListeners("lineup-local");   
        initializePositionSelectListeners("lineup-visitante"); 
        initializePlayerNameSelectListeners(); // MODIFIED: Initialize player name availability
        guardarEstadoPartido();
        alert("Partido reiniciado. Puedes comenzar un nuevo partido.");
      }
    }

    function terminarPartido() {
      if (registrosJuego.length > 0) exportarJuegoCSV();
      reiniciarPartido();
      alert("Partido terminado y datos exportados. Campos limpiados para un nuevo partido.");
    }

    function guardarEstadoPartido() {
      const localLineupRows = Array.from(document.getElementById("lineup-local").querySelectorAll("tbody tr"));
      const visitanteLineupRows = Array.from(document.getElementById("lineup-visitante").querySelectorAll("tbody tr"));
      const parseLineupRow = (row) => { 
          const jugadorSelect = row.querySelector(".jugador-select");
          const posicionSelect = row.querySelector(".posicion-select");
          const jugador = jugadorSelect ? jugadorSelect.value : "";
          const posicion = posicionSelect ? posicionSelect.value : "";
          const inningsData = {};
          for (let i = 4; i < row.cells.length; i++) {
              const inningNum = i - 3; 
              const label = row.cells[i].querySelector(".ining-label");
              const pitcherInput = row.cells[i].querySelector(".pitcher-name-input"); 
              if (label && label.textContent) {
                  inningsData[inningNum] = {
                    jugadas: label.textContent,
                    pitcher: pitcherInput ? pitcherInput.value : "" 
                  };
              }
          }
          return { jugador, posicion, innings: inningsData };
      };
      const localLineup = localLineupRows.map(row => parseLineupRow(row));
      const visitanteLineup = visitanteLineupRows.map(row => parseLineupRow(row));
      partidoData = {
        fecha: document.getElementById("fecha").value,
        formato: document.getElementById("formato").value,
        numeroJuego: document.getElementById("numeroJuego").value,
        localTeamName: document.getElementById("local-team-name").value,
        visitanteTeamName: document.getElementById("visitante-team-name").value,
        registros: registrosJuego, maxInnings: maxInnings, currentInning: currentInning, 
        isTopInning: isTopInning, outs: outs, bases: bases, 
        showDetails: !document.getElementById('game-details-container').classList.contains('hidden'),
        localLineup: localLineup, visitanteLineup: visitanteLineup
      };
      localStorage.setItem("partidoEnCurso", JSON.stringify(partidoData));
    }

    function cargarEstadoPartido() {
      const savedData = localStorage.getItem("partidoEnCurso");
      if (savedData) {
        partidoData = JSON.parse(savedData);
        registrosJuego = partidoData.registros || [];
        maxInnings = partidoData.maxInnings || 9;
        currentInning = partidoData.currentInning || 1; 
        isTopInning = (typeof partidoData.isTopInning === 'boolean') ? partidoData.isTopInning : true;
        outs = (typeof partidoData.outs === 'number') ? partidoData.outs : 0; 
        bases = partidoData.bases || [false, false, false];
        document.getElementById("fecha").value = partidoData.fecha || new Date().toISOString().split('T')[0];
        document.getElementById("formato").value = partidoData.formato || "";
        document.getElementById("numeroJuego").value = partidoData.numeroJuego || "";
        reconstruirTablaResumen();
        document.getElementById("local-team-name").value = partidoData.localTeamName || "Local";
        document.getElementById("visitante-team-name").value = partidoData.visitanteTeamName || "Visitante";
        document.getElementById("lineup-local-name").value = partidoData.localTeamName || "Local";
        document.getElementById("lineup-visitante-name").value = partidoData.visitanteTeamName || "Visitante";

        if (partidoData.localLineup && partidoData.localLineup.length > 0) {
            reconstruirLineupDesdeGuardado("lineup-local", partidoData.localLineup);
        } else {
            document.getElementById("lineup-local").querySelector("tbody").innerHTML = "";
            reconstruirLineupInnings("lineup-local"); 
        }
        if (partidoData.visitanteLineup && partidoData.visitanteLineup.length > 0) {
            reconstruirLineupDesdeGuardado("lineup-visitante", partidoData.visitanteLineup);
        } else {
            document.getElementById("lineup-visitante").querySelector("tbody").innerHTML = "";
            reconstruirLineupInnings("lineup-visitante"); 
        }
        actualizarResumenGlobal();
        actualizarRegistrosUI();
        const gameDetailsContainer = document.getElementById('game-details-container');
        if (partidoData.showDetails) {
            gameDetailsContainer.classList.remove('hidden');
            document.querySelector('.toggle-details-btn').innerHTML = '<i class="fas fa-cog"></i> Esconder Detalles Adicionales';
        } else {
            gameDetailsContainer.classList.add('hidden');
            document.querySelector('.toggle-details-btn').innerHTML = '<i class="fas fa-cog"></i> Mostrar Detalles Adicionales';
        }
      }
    }

    function reconstruirLineupDesdeGuardado(tablaId, savedLineup) {
        const tbody = document.getElementById(tablaId).querySelector("tbody");
        tbody.innerHTML = ""; 
        const jugadoresEnLocalStorage = obtenerJugadores();
        const jugadasOptions = obtenerJugadas().map(j => `<option value="${j.nombre}">${j.nombre}</option>`).join("");
        const theadRow = document.getElementById(tablaId).querySelector("thead tr");
        while (theadRow.children.length > 4) { 
            theadRow.removeChild(theadRow.lastElementChild);
        }
        for (let i = 1; i <= maxInnings; i++) {
            const newTh = document.createElement("th");
            newTh.textContent = i;
            newTh.classList.add('inning-column', `inning-${i}`); 
            theadRow.appendChild(newTh);
        }
        savedLineup.forEach((playerData, index) => {
            const tr = document.createElement("tr");
            const playerIndex = index + 1; 
            let celdasIning = "";
            for (let inning = 1; inning <= maxInnings; inning++) {
                const inningDetails = playerData.innings[inning] || { jugadas: "", pitcher: "" };
                const labelText = inningDetails.jugadas;
                const pitcherName = inningDetails.pitcher;
                const isActiveInning = (inning === currentInning); 
                celdasIning += `
                    <td class="inning-column inning-${inning} ${isActiveInning ? 'active' : ''}">
                        <div class="ining-container">
                            <select class="ining-select"><option value="">--</option>${jugadasOptions}</select>
                            <input type="number" class="ining-input" value="1" min="-999" max="999">
                            <button class="ining-guardar" onclick="guardarJugada(this, '${tablaId}', ${inning})"><i class="fas fa-save"></i> Guardar</button>
                            <div class="ining-label">${labelText}</div>
                            <input type="hidden" class="pitcher-name-input" value="${pitcherName}"></div></td>`;
            }
            const opcionesJugadores = jugadoresEnLocalStorage.map(j => 
                `<option value="${j.nombre}" ${j.nombre === playerData.jugador ? 'selected' : ''}>${j.nombre}</option>`
            ).join("");
            const opcionesPosiciones = posiciones.map(p => 
                `<option value="${p}" ${p === playerData.posicion ? 'selected' : ''}>${p}</option>`
            ).join("");
            tr.innerHTML = `
                <td class="sticky-column-1">${playerIndex}</td>
                <td class="sticky-column-2"><select class="jugador-select"><option value="">Seleccionar</option>${opcionesJugadores}</select></td>
                <td class="sticky-column-3"><select class="posicion-select"><option value="">--</option>${opcionesPosiciones}</select></td>
                <td class="sticky-column-delete">
                    <button class="delete-player-btn" onclick="eliminarJugador(this, '${tablaId}')">X</button></td>
                ${celdasIning}`;
            tbody.appendChild(tr);
        });
        showInning(currentInning);
        initializePositionSelectListeners(tablaId); 
        // initializePlayerNameSelectListeners(); // Called globally after all reconstructions
    }

    function showInning(inningNum) {
      currentInning = inningNum;
      document.getElementById('current-inning-display').textContent = `Inning ${inningNum}`;
      const allInningColumns = document.querySelectorAll('#lineup-local .inning-column, #lineup-visitante .inning-column');
      allInningColumns.forEach(col => {
        const colInningNumMatch = col.className.match(/inning-(\d+)/);
        if (colInningNumMatch) {
            const colInningNum = parseInt(colInningNumMatch[1]);
            if (colInningNum === inningNum) col.classList.add('active');
            else col.classList.remove('active');
        }
      });
      actualizarEstadisticasAdicionales(); 
      guardarEstadoPartido(); 
    }

    function showPrevInning() {
      if (currentInning > 1) showInning(currentInning - 1);
    }

    function showNextInning() {
      if (currentInning < maxInnings) showInning(currentInning + 1);
    }

    function toggleGameDetails() {
        const detailsContainer = document.getElementById('game-details-container');
        const toggleButton = document.querySelector('.toggle-details-btn');
        if (detailsContainer.classList.contains('hidden')) {
            detailsContainer.classList.remove('hidden');
            toggleButton.innerHTML = '<i class="fas fa-cog"></i> Esconder Detalles Adicionales';
            partidoData.showDetails = true;
        } else {
            detailsContainer.classList.add('hidden');
            toggleButton.innerHTML = '<i class="fas fa-cog"></i> Mostrar Detalles Adicionales';
            partidoData.showDetails = false;
        }
        guardarEstadoPartido();
    }

    function toggleTopDown() {
        isTopInning = !isTopInning;
        outs = 0; 
        clearBases(); 
        actualizarEstadisticasAdicionales(); 
        guardarEstadoPartido();
    }

    function addOut(quantity = 1) {
        outs += quantity;
        if (outs >= 3) {
            outs = 0; 
            clearBases(); 
            if (isTopInning) {
                isTopInning = false; 
            } else {
                isTopInning = true; 
                currentInning++; 
                if (currentInning > maxInnings) currentInning = maxInnings; 
                showInning(currentInning); 
            }
        }
        actualizarEstadisticasAdicionales(); 
        guardarEstadoPartido();
    }

    function resetOuts() {
        outs = 0;
        actualizarEstadisticasAdicionales(); 
        guardarEstadoPartido();
    }

    function updateBasesDisplay() {
        document.getElementById('base1').classList.toggle('occupied', bases[0]);
        document.getElementById('base2').classList.toggle('occupied', bases[1]);
        document.getElementById('base3').classList.toggle('occupied', bases[2]);
    }

    function toggleBase(baseNumber) {
        bases[baseNumber - 1] = !bases[baseNumber - 1]; 
        updateBasesDisplay();
        guardarEstadoPartido();
    }

    function clearBases() {
        bases = [false, false, false];
        updateBasesDisplay();
        guardarEstadoPartido();
    }

    window.onload = function() {
      inicializarDatosEjemplo();
      cargarFormatos();
      cargarEstadoPartido(); 
      
      initializePositionSelectListeners("lineup-local");   
      initializePositionSelectListeners("lineup-visitante"); 
      initializePlayerNameSelectListeners(); // MODIFIED: Initialize player name availability globally

      showInning(currentInning);
      const jugadas = obtenerJugadas();
      if (jugadas.length === 0) {
        console.warn("No se encontraron jugadas registradas. Por favor, agregue jugadas primero.");
      }
      document.querySelector('a[href="index.html"]').addEventListener("click", function(e) {
        guardarEstadoPartido();
      });
    };

    window.addEventListener("beforeunload", function(e) {
      guardarEstadoPartido();
    });
  </script>
</body>
</html>